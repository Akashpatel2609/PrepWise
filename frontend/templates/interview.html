<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PrepWise - Interview in Progress</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
  <div class="nav-container">
    <a href="{{ url_for('setup') }}" class="logo">PrepWise</a>
    <div class="nav-links">
      <span style="font-weight:600;color:var(--btn-bg);">Interview in Progress</span>
      <div class="profile-icon">U</div>
    </div>
  </div>
</nav>

<div style="padding:1.5rem;">
  <!-- Interview Header -->
  <div style="text-align:center;margin-bottom:2rem;">
    <h2 style="color:var(--text-dark);margin-bottom:0.5rem;">
      Question <span id="currentQuestion">1</span> of {{ num_questions }}
    </h2>
    <div class="timer" id="questionTimer">{{ minutes_per_question }}:00</div>
  </div>

  <!-- Main Interview Grid -->
  <div class="grid-2">
    <!-- Question Window -->
    <div class="window">
      <div style="height:100%;display:flex;flex-direction:column;">
        <h3 style="color:var(--text-dark);margin-bottom:1rem;border-bottom:2px solid var(--border-purple);padding-bottom:0.5rem;">
          Interview Question
        </h3>

        <div class="question-container" style="flex:1;display:flex;flex-direction:column;justify-content:center;">
          <p class="question-text" id="questionText">Loading your personalized question...</p>

          <!-- Hint Section -->
          <div id="hintContainer" style="margin-top:1.5rem;padding:1rem;background:#f8f9fa;border-left:4px solid var(--border-purple);border-radius:0 8px 8px 0;display:none;">
            <div style="display:flex;align-items:center;margin-bottom:0.5rem;">
              <span style="color:var(--border-purple);font-weight:600;font-size:0.9rem;">üí° Helpful Hint</span>
            </div>
            <p id="hintText" style="color:#666;font-size:0.9rem;margin:0;line-height:1.4;"></p>
          </div>
        </div>

        <!-- Question Controls -->
        <div style="display:flex;justify-content:space-between;margin-top:1.5rem;">
          <button id="skipQuestion" class="btn btn-secondary">Skip Question</button>
          <div style="display:flex;gap:1rem;">
            <button id="pauseInterview" class="btn btn-secondary">‚è∏Ô∏è Pause</button>
            <button id="nextQuestion" class="btn">Next Question ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Feed Window -->
    <div class="window">
      <div style="height:100%;display:flex;flex-direction:column;">
        <h3 style="color:var(--text-dark);margin-bottom:1rem;border-bottom:2px solid var(--border-purple);padding-bottom:0.5rem;">
          Video Feed
        </h3>

        <div class="video-container" style="flex:1;margin-bottom:1rem;position:relative;">
          <video id="interviewWebcam" class="video-feed" autoplay muted playsinline></video>

          <!-- Recording Indicator -->
          <div style="position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:0.5rem;background:rgba(0,0,0,0.7);padding:0.5rem;border-radius:4px;">
            <div style="width:8px;height:8px;background:#ff4444;border-radius:50%;animation:pulse 1s infinite;"></div>
            <span style="color:white;font-size:0.8rem;">REC</span>
          </div>

          <!-- Analysis Status -->
          <div style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);padding:0.5rem;border-radius:4px;">
            <div style="color:white;font-size:0.8rem;">
              <div>üéØ Body Language: <span id="postureStatus">Analyzing...</span></div>
              <div>üé§ Speech: <span id="speechStatus">Listening...</span></div>
            </div>
          </div>
        </div>

        <!-- Video Controls -->
        <div class="video-controls">
          <button id="toggleMicInterview" class="control-btn">üé§ <span id="micStatusText">On</span></button>
          <button id="toggleCameraInterview" class="control-btn">üìπ <span id="cameraStatusText">On</span></button>
          <button id="toggleAnalysis" class="control-btn">üìä Analysis: <span id="analysisStatusText">On</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Interview Complete Modal -->
<div id="completeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:2rem;border-radius:12px;text-align:center;max-width:400px;">
    <h3 style="color:var(--text-dark);margin-bottom:1rem;">üéâ Interview Complete!</h3>
    <p style="color:#666;margin-bottom:2rem;">Thank you for completing the interview. Your responses have been analyzed and your feedback report is ready.</p>
    <button onclick="goToFeedback()" class="btn" style="width:100%;">View Feedback Report</button>
  </div>
</div>
<script>window.API_BASE = 'http://127.0.0.1:8000';</script>
<script src="{{ url_for('static', filename='js/interview.js') }}"></script>

<script>
  // ==== Server-provided values ====
  const TOTAL_QUESTIONS = {{ num_questions or 5 }};
  const MINUTES_PER_QUESTION = {{ minutes_per_question or 2 }};
  const SESSION_ID = "{{ session.get('session_id', '') }}";

  // ==== Interview state ====
  let currentQuestionIndex = 1;
  let timeRemaining = MINUTES_PER_QUESTION * 60;
  let timerInterval;

  // UI toggles
  let micEnabled = true;
  let cameraEnabled = true;
  let analysisEnabled = true;

  // ==== Data buffer that drives UI/feedback fallback ====
  window.interviewData = {
    total_words: 0,
    total_speaking_time: 0,
    total_questions: TOTAL_QUESTIONS,
    questions_answered: 0,
    questions_skipped: 0,
    transcript: [],
    filler_words: { um: 0, uh: 0, like: 0 },
    posture_data: [],
    sample_response: ""
  };

  // used by timers + vad
  let speakingTimeForCurrentQuestion = 0;

  // ===== Backend transcript merge hook (called by interview.js) =====
  window.appendBackendTranscript = function(text, qn, confidence) {
    const trimmed = (text || '').trim();
    if (!trimmed) return;

    const now = new Date().toLocaleTimeString();
    const last = interviewData.transcript[interviewData.transcript.length - 1];
    const merge = last && last.question_number === qn && (Date.now() - (last.lastUpdated || 0)) < 7000;

    if (merge) {
      last.response += ' ' + trimmed;
      last.duration = speakingTimeForCurrentQuestion;
      last.confidence = Math.max(last.confidence || 0, confidence || 0.9);
      last.lastUpdated = Date.now();
    } else {
      interviewData.transcript.push({
        question_number: qn,
        question: window.currentQuestionText || `Question ${qn}`,
        response: trimmed,
        timestamp: now,
        duration: speakingTimeForCurrentQuestion,
        confidence: confidence || 0.9,
        lastUpdated: Date.now()
      });
    }

    // word + filler tally
    const words = trimmed.split(/\s+/).filter(Boolean);
    interviewData.total_words += words.length;
    words.forEach(w => {
      const lw = w.toLowerCase().replace(/[^\w]/g,'');
      if (lw === 'um') interviewData.filler_words.um++;
      if (lw === 'uh') interviewData.filler_words.uh++;
      if (lw === 'like') interviewData.filler_words.like++;
    });

    if (!interviewData.sample_response && trimmed.length > 15) {
      interviewData.sample_response = trimmed;
    }

    // mark answered for this question
    interviewData.questions_answered = Math.max(interviewData.questions_answered, qn);
  };

  // ===== Questions =====
  let currentQuestionText = '';
  async function loadNextQuestion() {
    try {
      const res = await fetch('/api/generate-question');
      const data = await res.json();
      currentQuestionText = data.question || 'Please share a recent accomplishment you are proud of.';
      const qEl = document.getElementById('questionText');
      if (qEl) {
        qEl.textContent = currentQuestionText;
        qEl.style.opacity = '0.5';
        setTimeout(() => (qEl.style.opacity = '1'), 100);
      }
      const hint = document.getElementById('hintContainer');
      const hintText = document.getElementById('hintText');
      if (data.hint && hint && hintText) {
        hintText.textContent = data.hint;
        hint.style.display = 'block';
      } else if (hint) {
        hint.style.display = 'none';
      }
    } catch (e) {
      console.error('Error loading question:', e);
      const qEl = document.getElementById('questionText');
      if (qEl) qEl.textContent = 'Error loading question. Please try again.';
      const hint = document.getElementById('hintContainer');
      if (hint) hint.style.display = 'none';
    }
  }

  // ===== Timer =====
  function startTimer() {
    clearInterval(timerInterval);
    timeRemaining = MINUTES_PER_QUESTION * 60;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timeRemaining--;
      updateTimerDisplay();
      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        document.getElementById('nextQuestion')?.click();
      }
    }, 1000);
  }
  function updateTimerDisplay() {
    const t = Math.max(0, timeRemaining);
    const m = Math.floor(t / 60);
    const s = t % 60;
    const el = document.getElementById('questionTimer');
    if (el) el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  }
  function resetTimer() {
    clearInterval(timerInterval);
    timeRemaining = MINUTES_PER_QUESTION * 60;
    updateTimerDisplay();
  }

  // ===== Navigation =====
  async function nextQuestion() {
    if (
      speakingTimeForCurrentQuestion > 0 ||
      (interviewData.transcript.slice(-1)[0]?.question_number === currentQuestionIndex)
    ) {
      interviewData.questions_answered = Math.max(interviewData.questions_answered, currentQuestionIndex);
    }

    if (currentQuestionIndex >= TOTAL_QUESTIONS) {
      completeInterview();
      return;
    }

    currentQuestionIndex++;
    speakingTimeForCurrentQuestion = 0;
    const idxEl = document.getElementById('currentQuestion');
    if (idxEl) idxEl.textContent = currentQuestionIndex;
    resetTimer();
    startTimer();
    await loadNextQuestion();
  }

  function skipQuestion() {
    if (!confirm('Skip this question? This may negatively impact your score.')) return;
    interviewData.questions_skipped++;
    if (currentQuestionIndex >= TOTAL_QUESTIONS) {
      completeInterview();
      return;
    }
    currentQuestionIndex++;
    speakingTimeForCurrentQuestion = 0;
    const idxEl = document.getElementById('currentQuestion');
    if (idxEl) idxEl.textContent = currentQuestionIndex;
    resetTimer();
    startTimer();
    loadNextQuestion();
  }

  // ===== Simple posture/speech status simulation =====
  function startAnalysisSimulation() {
    setInterval(() => {
      if (!analysisEnabled) return;
      const postureStates = ['Good Posture','Slouching','Confident Expression','Nervous Expression'];
      const st = postureStates[Math.floor(Math.random()*postureStates.length)];
      const el = document.getElementById('postureStatus');
      if (el) el.textContent = st;
      interviewData.posture_data.push({ posture_class: st, timestamp: Date.now() });
      if (interviewData.posture_data.length > 60) {
        interviewData.posture_data = interviewData.posture_data.slice(-60);
      }
    }, 3000);
  }

  // ===== Complete interview =====
  async function completeInterview() {
    clearInterval(timerInterval);
    try {
      await fetch('/api/submit-interview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(interviewData)
      });
    } catch (e) {
      console.error('Error submitting interview data:', e);
    }
    const m = document.getElementById('completeModal');
    if (m) m.style.display = 'block';
  }

  function goToFeedback() {
    window.location.href = "{{ url_for('feedback') }}";
  }

  // ===== UI controls =====
  document.getElementById('toggleMicInterview')?.addEventListener('click', () => {
    const ms = window.interviewManager?.mediaStream;
    if (!ms) return;
    const track = ms.getAudioTracks()[0];
    if (!track) return;
    track.enabled = !track.enabled;
    micEnabled = track.enabled;
    const t = document.getElementById('micStatusText');
    if (t) t.textContent = micEnabled ? 'On' : 'Off';
    const btn = document.getElementById('toggleMicInterview');
    if (btn) btn.style.backgroundColor = micEnabled ? 'var(--btn-bg)' : '#dc3545';
  });

  document.getElementById('toggleCameraInterview')?.addEventListener('click', () => {
    const ms = window.interviewManager?.mediaStream;
    if (!ms) return;
    const track = ms.getVideoTracks()[0];
    if (!track) return;
    track.enabled = !track.enabled;
    cameraEnabled = track.enabled;
    const t = document.getElementById('cameraStatusText');
    if (t) t.textContent = cameraEnabled ? 'On' : 'Off';
    const btn = document.getElementById('toggleCameraInterview');
    if (btn) btn.style.backgroundColor = cameraEnabled ? 'var(--btn-bg)' : '#dc3545';
  });

  document.getElementById('toggleAnalysis')?.addEventListener('click', () => {
    analysisEnabled = !analysisEnabled;
    const t = document.getElementById('analysisStatusText');
    if (t) t.textContent = analysisEnabled ? 'On' : 'Off';
    const btn = document.getElementById('toggleAnalysis');
    if (btn) btn.style.backgroundColor = analysisEnabled ? 'var(--btn-bg)' : '#dc3545';
  });

  document.getElementById('nextQuestion')?.addEventListener('click', nextQuestion);
  document.getElementById('skipQuestion')?.addEventListener('click', skipQuestion);

  document.getElementById('pauseInterview')?.addEventListener('click', function () {
    if (timerInterval) {
      clearInterval(timerInterval);
      this.textContent = '‚ñ∂Ô∏è Resume';
      this.onclick = () => {
        startTimer();
        this.textContent = '‚è∏Ô∏è Pause';
        this.onclick = null;
      };
    }
  });

  // CSS pulse (used by REC indicator)
  const style = document.createElement('style');
  style.textContent = `@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}`;
  document.head.appendChild(style);

  // ===== Boot (use ONLY the class recorder) =====
  async function initializeInterview() {
    try { await fetch('/api/reset-questions', { method:'POST' }); } catch (e) { console.warn('reset-questions failed', e); }
    await window.interviewManager.start(SESSION_ID);   // <<<<<< ONLY recorder
    await loadNextQuestion();
    startTimer();
    startAnalysisSimulation();
  }

  window.addEventListener('load', () => {
    console.log('üöÄ Initializing interview‚Ä¶');
    const idxEl = document.getElementById('currentQuestion');
    if (idxEl) idxEl.textContent = currentQuestionIndex;
    initializeInterview();
  });
</script>

</body>
</html>
